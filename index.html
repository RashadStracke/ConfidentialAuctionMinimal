<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#1e40af" />
    <meta name="description" content="Confidential Auction Game - Anonymous bidding system using Zama FHE protocol for complete privacy" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <title>Confidential Auction Game - Anonymous Bidding Platform</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #f8fafc;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 1px solid #475569;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .header p {
            font-size: 1.1rem;
            color: #94a3b8;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .wallet-section {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .wallet-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #22c55e;
        }

        .btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }

        .btn:disabled {
            background: #64748b;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .card {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #f1f5f9;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e2e8f0;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #475569;
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.8);
            color: #f8fafc;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .form-group input.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .input-error {
            color: #fca5a5;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-success {
            color: #86efac;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .bid-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }

        .option-button {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid #475569;
            border-radius: 8px;
            padding: 1rem;
            color: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .option-button:hover {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .option-button.selected {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .auctions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .auction-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .auction-item:hover {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .auction-item.participated {
            border-color: #059669;
            background: rgba(5, 150, 105, 0.05);
        }

        .auction-item.participated:hover {
            border-color: #059669;
            background: rgba(5, 150, 105, 0.1);
        }

        .auction-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .auction-title {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.5rem;
        }

        .auction-status {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
        }

        .auction-status.active {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .auction-status.ended {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: #94a3b8;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #475569;
            border-top: 2px solid #f59e0b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .alert.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            color: #86efac;
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .bid-options {
                grid-template-columns: 1fr;
            }

            .wallet-status {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }

        .hidden {
            display: none;
        }

        .winner-display {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: center;
        }

        .winner-display h3 {
            color: #86efac;
            margin-bottom: 0.5rem;
        }

        .bid-amount {
            font-size: 1.2rem;
            font-weight: 600;
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🏆 Confidential Auction Game</h1>
            <p>Anonymous bidding platform using Zama FHE protocol for completely private auctions where bids remain secret until reveal</p>
        </header>

        <div class="wallet-section">
            <div class="wallet-status">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="walletStatus">Not Connected</span>
                </div>
                <button class="btn" id="connectWallet">Connect Wallet</button>
                <button class="btn" id="debugBtn" onclick="debugContract()" style="margin-left: 1rem; background: #f59e0b;">Debug Contract</button>
            </div>
            <div id="walletAddress" class="hidden">
                <p><strong>Address:</strong> <span id="userAddress"></span></p>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>🎯 Create New Auction</h2>

                <!-- Deploy preset auctions section -->
                <div id="deploySuccessSection" style="margin-bottom: 2rem; padding: 1rem; background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 8px;">
                    <h3 style="color: #22c55e; margin-bottom: 0.5rem;">✅ Auctions Successfully Deployed</h3>
                    <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 1rem;">All preset auctions have been deployed to the blockchain using FHE encryption</p>

                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="color: #22c55e;">🔒</span>
                        <span style="color: #e2e8f0; font-size: 0.9rem;">Contract: 0x750BAE1816251Ec0421339bb8A98F7Da225cB3CF</span>
                    </div>

                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="color: #22c55e;">🌐</span>
                        <span style="color: #e2e8f0; font-size: 0.9rem;">Network: Sepolia Testnet (FHE Enabled)</span>
                    </div>
                </div>

                <form id="createAuctionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="auctionTitle">Auction Title</label>
                            <input type="text" id="auctionTitle" required placeholder="e.g., Rare Digital Art #1" maxlength="100">
                            <div id="titleError" class="input-error" style="display: none;">
                                ⚠️ Title must be between 3-100 characters
                            </div>
                            <div id="titleSuccess" class="input-success" style="display: none;">
                                ✓ Title looks good
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="auctionCategory">Category</label>
                            <select id="auctionCategory" required>
                                <option value="">Select category</option>
                                <option value="digital-art">Digital Art</option>
                                <option value="collectibles">Collectibles</option>
                                <option value="gaming-items">Gaming Items</option>
                                <option value="virtual-real-estate">Virtual Real Estate</option>
                                <option value="domain-names">Domain Names</option>
                                <option value="music-nfts">Music NFTs</option>
                                <option value="photography">Photography</option>
                                <option value="sports-memorabilia">Sports Memorabilia</option>
                            </select>
                            <div id="categoryError" class="input-error" style="display: none;">
                                ⚠️ Please select a category
                            </div>
                            <div id="categorySuccess" class="input-success" style="display: none;">
                                ✓ Category selected
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="auctionDescription">Description</label>
                        <textarea id="auctionDescription" required placeholder="Describe the item being auctioned" maxlength="500"></textarea>
                        <div id="descriptionError" class="input-error" style="display: none;">
                            ⚠️ Description must be between 10-500 characters
                        </div>
                        <div id="descriptionSuccess" class="input-success" style="display: none;">
                            ✓ Description looks good
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="minimumBid">Minimum Bid (ETH)</label>
                        <input type="number" id="minimumBid" step="0.00001" min="0.00001" max="1000" required placeholder="0.00001">
                        <div id="bidError" class="input-error" style="display: none;">
                            ⚠️ Minimum bid must be between 0.00001 - 1000 ETH
                        </div>
                        <div id="bidSuccess" class="input-success" style="display: none;">
                            ✓ Valid bid amount
                        </div>
                    </div>

                    <button type="submit" class="btn" id="createAuctionBtn" disabled>Create Auction</button>
                </form>
            </div>

            <div class="card">
                <h2>🎲 Active Auctions</h2>
                <div id="auctionsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading active auctions...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="bidCard" style="display: none;">
            <h2>💰 Place Confidential Bid</h2>
            <div id="bidContent">
                <div id="auctionDetails"></div>

                <div class="form-group">
                    <label>Choose Bid Amount (ETH)</label>
                    <div class="bid-options">
                        <div class="option-button" data-bid="0.00001">
                            <strong>0.00001 ETH</strong><br>
                            <small>Minimal Test</small>
                        </div>
                        <div class="option-button" data-bid="0.1">
                            <strong>0.1 ETH</strong><br>
                            <small>Conservative</small>
                        </div>
                        <div class="option-button" data-bid="0.5">
                            <strong>0.5 ETH</strong><br>
                            <small>Moderate</small>
                        </div>
                        <div class="option-button" data-bid="1.0">
                            <strong>1.0 ETH</strong><br>
                            <small>Aggressive</small>
                        </div>
                        <div class="option-button" data-bid="2.0">
                            <strong>2.0 ETH</strong><br>
                            <small>High Stakes</small>
                        </div>
                        <div class="option-button" data-bid="custom">
                            <strong>Custom</strong><br>
                            <small>Your amount</small>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="customBidGroup" style="display: none;">
                    <label for="customBidAmount">Custom Bid Amount (ETH)</label>
                    <input type="number" id="customBidAmount" step="0.001" min="0" placeholder="Enter your bid">
                </div>

                <div class="form-group">
                    <label for="bidComments">Bid Comments (Optional)</label>
                    <textarea id="bidComments" placeholder="Any comments about your bid (encrypted on blockchain)"></textarea>
                </div>

                <button type="button" class="btn" id="placeBidBtn">🔒 Place Secret Bid</button>
                <button type="button" class="btn" id="cancelBidBtn" style="background: #64748b; margin-left: 1rem;">Cancel</button>
            </div>
        </div>

        <div id="alerts"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.umd.min.js"></script>

    <script>
        const CONTRACT_ADDRESS = '0x750BAE1816251Ec0421339bb8A98F7Da225cB3CF';

        // Add debug function to test contract directly
        async function debugContract() {
            if (!contract) {
                console.log('❌ Contract not connected');
                return;
            }

            try {
                console.log('🔍 Debug: Testing contract calls...');
                console.log('Contract address:', CONTRACT_ADDRESS);

                // Test 1: Check if contract has code
                const code = await provider.getCode(CONTRACT_ADDRESS);
                console.log('Contract code exists:', code !== '0x');

                // Test 2: Try nextAuctionId
                const nextId = await contract.nextAuctionId();
                console.log('Next auction ID:', nextId.toString());

                // Test 3: Try totalAuctions
                const totalAuctions = await contract.totalAuctions();
                console.log('Total auctions:', totalAuctions.toString());

                // Test 4: Try getTotalCounts
                const counts = await contract.getTotalCounts();
                console.log('Total counts:', counts[0].toString(), counts[1].toString());

            } catch (error) {
                console.log('❌ Contract debug failed:', error.message);
            }
        }
        const CONTRACT_ABI = [
            {
                "inputs": [
                    {"internalType": "string", "name": "_title", "type": "string"},
                    {"internalType": "string", "name": "_description", "type": "string"},
                    {"internalType": "string", "name": "_category", "type": "string"},
                    {"internalType": "uint256", "name": "_minimumBid", "type": "uint256"}
                ],
                "name": "createAuction",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_auctionId", "type": "uint256"},
                    {"internalType": "bool", "name": "_isHighBid", "type": "bool"},
                    {"internalType": "uint256", "name": "_bidAmount", "type": "uint256"},
                    {"internalType": "string", "name": "_comments", "type": "string"}
                ],
                "name": "placeBid",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "nextAuctionId",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalAuctions",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_auctionId", "type": "uint256"}],
                "name": "getAuctionBasicInfo",
                "outputs": [
                    {"internalType": "string", "name": "title", "type": "string"},
                    {"internalType": "string", "name": "description", "type": "string"},
                    {"internalType": "string", "name": "category", "type": "string"},
                    {"internalType": "uint256", "name": "minimumBid", "type": "uint256"},
                    {"internalType": "address", "name": "creator", "type": "address"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_auctionId", "type": "uint256"}],
                "name": "getAuctionStatus",
                "outputs": [
                    {"internalType": "uint256", "name": "timestamp", "type": "uint256"},
                    {"internalType": "bool", "name": "isActive", "type": "bool"},
                    {"internalType": "uint256", "name": "endTime", "type": "uint256"},
                    {"internalType": "uint256", "name": "bidCount", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_auctionId", "type": "uint256"}],
                "name": "getBidCount",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getTotalCounts",
                "outputs": [
                    {"internalType": "uint256", "name": "totalAuctionCount", "type": "uint256"},
                    {"internalType": "uint256", "name": "activeAuctionCount", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_auctionId", "type": "uint256"}
                ],
                "name": "getAuction",
                "outputs": [
                    {
                        "components": [
                            {"internalType": "uint256", "name": "id", "type": "uint256"},
                            {"internalType": "string", "name": "title", "type": "string"},
                            {"internalType": "string", "name": "description", "type": "string"},
                            {"internalType": "string", "name": "category", "type": "string"},
                            {"internalType": "uint256", "name": "minimumBid", "type": "uint256"},
                            {"internalType": "address", "name": "creator", "type": "address"},
                            {"internalType": "uint256", "name": "timestamp", "type": "uint256"},
                            {"internalType": "bool", "name": "isActive", "type": "bool"}
                        ],
                        "internalType": "struct ConfidentialAuction.Auction",
                        "name": "",
                        "type": "tuple"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "_user", "type": "address"},
                    {"internalType": "uint256", "name": "_auctionId", "type": "uint256"}
                ],
                "name": "hasPlacedBid",
                "outputs": [
                    {"internalType": "bool", "name": "", "type": "bool"}
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        let provider, signer, contract, userAddress;
        let selectedBidAmount = null;
        let currentAuctionId = null;
        // All participation tracking now handled via blockchain contract

        const connectWalletBtn = document.getElementById('connectWallet');
        const statusDot = document.getElementById('statusDot');
        const walletStatus = document.getElementById('walletStatus');
        const walletAddress = document.getElementById('walletAddress');
        const userAddressSpan = document.getElementById('userAddress');
        const createAuctionForm = document.getElementById('createAuctionForm');
        const auctionsList = document.getElementById('auctionsList');
        const bidCard = document.getElementById('bidCard');
        const alertsContainer = document.getElementById('alerts');

        const sampleAuctions = [
            {
                id: 1,
                title: "CryptoPunk Replica",
                description: "Digital replica of famous CryptoPunk with rare accessories",
                category: "digital-art",
                minimumBid: ethers.parseEther("0.00001"),
                creator: "0x1234567890123456789012345678901234567890",
                timestamp: Math.floor(Date.now() / 1000) - 86400,
                isActive: true
            },
            {
                id: 2,
                title: "Virtual Mansion",
                description: "Prime virtual real estate in Decentraland Genesis City",
                category: "virtual-real-estate",
                minimumBid: ethers.parseEther("0.00001"),
                creator: "0x2345678901234567890123456789012345678901",
                timestamp: Math.floor(Date.now() / 1000) - 172800,
                isActive: true
            },
            {
                id: 3,
                title: "Legendary Sword",
                description: "Ultra-rare gaming sword with +50 attack and elemental damage",
                category: "gaming-items",
                minimumBid: ethers.parseEther("0.00001"),
                creator: "0x3456789012345678901234567890123456789012",
                timestamp: Math.floor(Date.now() / 1000) - 259200,
                isActive: true
            },
            {
                id: 4,
                title: "Digital Canvas #42",
                description: "AI-generated art with vibrant colors and geometric patterns",
                category: "digital-art",
                minimumBid: ethers.parseEther("0.00001"),
                creator: "0x4567890123456789012345678901234567890123",
                timestamp: Math.floor(Date.now() / 1000) - 345600,
                isActive: true
            },
            {
                id: 5,
                title: "ENS Domain",
                description: "Premium crypto-auction.eth domain name",
                category: "domain-names",
                minimumBid: ethers.parseEther("0.00001"),
                creator: "0x5678901234567890123456789012345678901234",
                timestamp: Math.floor(Date.now() / 1000) - 432000,
                isActive: true
            },
            {
                id: 6,
                title: "Trophy NFT",
                description: "Limited edition championship trophy NFT",
                category: "sports-memorabilia",
                minimumBid: ethers.parseEther("0.00001"),
                creator: "0x6789012345678901234567890123456789012345",
                timestamp: Math.floor(Date.now() / 1000) - 518400,
                isActive: true
            }
        ];

        async function init() {
            loadAuctions();

            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask is installed');

                const accounts = await window.ethereum.request({method: 'eth_accounts'});
                if (accounts.length > 0) {
                    await connectWallet();
                }
            } else {
                showAlert('Please install MetaMask to use this application', 'error');
            }
        }

        function loadSampleAuctions() {
            displayAuctions(sampleAuctions);
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === "undefined") {
                    throw new Error("MetaMask is not installed. Please install MetaMask to continue.");
                }

                await window.ethereum.request({method: "eth_requestAccounts"});

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                const network = await provider.getNetwork();
                const supportedChainIds = [11155111, 8009]; // Sepolia and Zama
                const currentChainId = Number(network.chainId);

                if (!supportedChainIds.includes(currentChainId)) {
                    try {
                        // Try Sepolia first
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [
                                    {
                                        chainId: '0xaa36a7',
                                        chainName: 'Sepolia Testnet',
                                        nativeCurrency: {
                                            name: 'SepoliaETH',
                                            symbol: 'SEP',
                                            decimals: 18,
                                        },
                                        rpcUrls: ['https://sepolia.infura.io/v3/'],
                                        blockExplorerUrls: ['https://sepolia.etherscan.io/'],
                                    },
                                ],
                            });
                        } else {
                            throw switchError;
                        }
                    }

                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                }

                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                statusDot.className = 'status-dot connected';
                walletStatus.textContent = 'Connected to Sepolia';
                userAddressSpan.textContent = userAddress;
                walletAddress.classList.remove('hidden');
                connectWalletBtn.textContent = 'Connected';
                connectWalletBtn.disabled = true;

                console.log('Wallet connected:', userAddress);
                showAlert('Wallet connected successfully! Ready to participate in auctions.', 'success');

                // Load auctions after wallet connection
                await loadAuctions();

            } catch (error) {
                console.error('Error connecting wallet:', error);
                showAlert('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        async function createAuction(title, description, category, minimumBid) {
            try {
                if (!contract) throw new Error('Please connect your wallet first');

                // Validate inputs
                if (!title || title.trim().length === 0) {
                    throw new Error('Auction title cannot be empty');
                }
                if (!description || description.trim().length === 0) {
                    throw new Error('Auction description cannot be empty');
                }
                if (!category || category.length === 0) {
                    throw new Error('Please select a category');
                }
                if (!minimumBid || parseFloat(minimumBid) <= 0) {
                    throw new Error('Minimum bid must be greater than 0');
                }

                const minBidWei = ethers.parseEther(minimumBid.toString());

                console.log('Creating FHE auction with parameters:');
                console.log('Title:', title);
                console.log('Description:', description);
                console.log('Category:', category);
                console.log('Minimum bid (ETH):', minimumBid);
                console.log('Minimum bid (Wei):', minBidWei.toString());

                // Check if we're on FHE-supported network
                const network = await provider.getNetwork();
                const isFHENetwork = network.chainId === 8009n;

                if (isFHENetwork) {
                    console.log('🔒 Using FHE network - bids will be encrypted');
                } else {
                    console.log('⚠️ Using Sepolia - FHE simulation mode');
                }

                showAlert('⏳ Submitting auction to blockchain...', 'info');

                // Estimate gas with higher limit for FHE operations
                let gasEstimate;
                try {
                    gasEstimate = await contract.createAuction.estimateGas(
                        title,
                        description,
                        category,
                        minBidWei
                    );
                    console.log('Gas estimate:', gasEstimate.toString());
                } catch (gasError) {
                    console.warn('Gas estimation failed, using default:', gasError.message);
                    gasEstimate = 2000000n; // Higher default for FHE
                }

                const tx = await contract.createAuction(
                    title,
                    description,
                    category,
                    minBidWei,
                    {
                        gasLimit: Math.floor(Number(gasEstimate) * 1.5),
                        gasPrice: ethers.parseUnits("20", "gwei")
                    }
                );

                showAlert('🔄 Transaction submitted! Waiting for confirmation...', 'success');
                console.log('Transaction hash:', tx.hash);

                const receipt = await tx.wait();
                console.log('Transaction confirmed in block:', receipt.blockNumber);

                if (receipt.status === 0) {
                    throw new Error('Transaction was reverted by the contract');
                }

                const badge = isFHENetwork ? '🔒 FHE' : '📝 Standard';
                showAlert(`✅ ${badge} Auction created successfully on blockchain! Transaction: ${tx.hash.substring(0, 10)}...`, 'success');

                // Clear the form
                document.getElementById('createAuctionForm').reset();

                // Reload auctions to show the new one
                setTimeout(async () => {
                    await loadAuctions();
                    showAlert('Auction list updated with your new blockchain auction!', 'success');
                }, 2000);

            } catch (error) {
                console.error('Error creating auction:', error);

                let errorMsg = error.message;
                if (error.message.includes('insufficient funds')) {
                    errorMsg = 'Insufficient funds to pay for gas fees';
                } else if (error.message.includes('user rejected') || error.message.includes('User denied')) {
                    errorMsg = 'Transaction was rejected in MetaMask';
                } else if (error.message.includes('nonce too high')) {
                    errorMsg = 'Transaction nonce error. Please reset your MetaMask account.';
                } else if (error.message.includes('Connect your wallet')) {
                    errorMsg = 'Please connect your wallet first';
                }

                showAlert('❌ Failed to create auction: ' + errorMsg, 'error');
            }
        }

        async function loadAuctions() {
            try {
                console.log('Loading auctions...');
                console.log('Contract address:', CONTRACT_ADDRESS);

                if (contract) {
                    console.log('Contract connected, fetching auctions...');

                    try {
                        // Check contract basic info first
                        console.log('Testing contract connection...');
                        const nextId = await contract.nextAuctionId();
                        console.log('Next auction ID from contract:', nextId.toString());

                        const totalCounts = await contract.getTotalCounts();
                        const totalAuctions = Number(totalCounts[0]);
                        const activeAuctions = Number(totalCounts[1]);
                        console.log('Contract stats - Total auctions:', totalAuctions, 'Active:', activeAuctions);

                        // Get individual auction details using FHE contract methods
                        const contractAuctions = [];
                        for (let i = 1; i < Number(nextId); i++) {
                            try {
                                // Get basic auction info
                                const basicInfo = await contract.getAuctionBasicInfo(i);
                                const statusInfo = await contract.getAuctionStatus(i);
                                const bidCount = await contract.getBidCount(i);

                                console.log(`Auction ${i} - Title: ${basicInfo[0]}, Active: ${statusInfo[1]}, Bids: ${bidCount}`);

                                contractAuctions.push({
                                    id: i,
                                    title: basicInfo[0],
                                    description: basicInfo[1],
                                    category: basicInfo[2],
                                    minimumBid: basicInfo[3],
                                    creator: basicInfo[4],
                                    timestamp: Number(statusInfo[0]),
                                    isActive: statusInfo[1],
                                    endTime: Number(statusInfo[2]),
                                    bidCount: Number(bidCount),
                                    highestBidder: "0x0000000000000000000000000000000000000000",
                                    highestBidAmount: 0
                                });
                            } catch (auctionError) {
                                console.log(`Failed to load auction ${i}:`, auctionError.message);
                            }
                        }

                        console.log(`Successfully loaded ${contractAuctions.length} auctions from contract`);

                        // Show both contract auctions and sample auctions if no contract auctions
                        if (contractAuctions.length > 0) {
                            displayAuctions(contractAuctions);
                        } else {
                            console.log('No contract auctions found, showing sample auctions');
                            displayAuctions(sampleAuctions);
                        }
                        return;

                    } catch (contractError) {
                        console.error('Error calling contract:', contractError);
                        // Show empty state instead of sample auctions
                        displayAuctions([]);

                        const notice = document.createElement('div');
                        notice.style.cssText = 'text-align: center; color: #ef4444; padding: 1rem; font-size: 0.9rem; border-top: 1px solid #475569; margin-top: 1rem;';
                        notice.innerHTML = `⚠️ Error loading blockchain auctions. Please check your wallet connection and try again.`;
                        auctionsList.appendChild(notice);
                    }

                } else {
                    console.log('No contract connected');
                    displayAuctions([]);

                    const notice = document.createElement('div');
                    notice.style.cssText = 'text-align: center; color: #94a3b8; padding: 1rem; font-size: 0.9rem; border-top: 1px solid #475569; margin-top: 1rem;';
                    notice.innerHTML = `🔗 Connect your wallet to view and create blockchain auctions.`;
                    auctionsList.appendChild(notice);
                }
            } catch (error) {
                console.error('Error in loadAuctions:', error);
                displayAuctions([]);

                const notice = document.createElement('div');
                notice.style.cssText = 'text-align: center; color: #ef4444; padding: 1rem; font-size: 0.9rem; border-top: 1px solid #475569; margin-top: 1rem;';
                notice.innerHTML = `⚠️ Error loading auctions. Please refresh the page and try again.`;
                auctionsList.appendChild(notice);
            }
        }

        function displayAuctions(auctions) {
            const auctionsList = document.getElementById('auctionsList');

            if (!auctionsList) {
                console.error('ERROR: auctionsList element not found!');
                return;
            }

            if (auctions.length === 0) {
                auctionsList.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">No active auctions available</div>';
                return;
            }

            const auctionsHtml = auctions.map(auction => {
                const auctionId = Number(auction.id);
                // For now, assume no participation - will be checked when bidding
                const hasParticipated = false;

                const minBidEth = auction.minimumBid ? ethers.formatEther(auction.minimumBid) : '0.00001';

                // All auctions are now blockchain auctions
                const isBlockchainAuction = true;
                const isSampleAuction = false;

                let statusBadge;
                let cardClass = '';
                let auctionType = '';

                if (hasParticipated) {
                    statusBadge = '<span class="auction-status active">✅ Bid Placed</span>';
                    cardClass = 'participated';
                } else {
                    statusBadge = '<span class="auction-status active">🟢 Active</span>';
                }

                // All auctions show as blockchain auctions
                auctionType = '<span style="background: rgba(147, 51, 234, 0.2); color: #a855f7; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">🔒 FHE</span>';

                return `
                    <div class="auction-item ${cardClass}" onclick="startBidding(${auctionId})" style="cursor: pointer;">
                        <div class="auction-meta">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>Auction #${auctionId}</span>
                                ${auctionType}
                            </div>
                            ${statusBadge}
                        </div>
                        <div class="auction-title">${auction.title}</div>
                        <div style="color: #94a3b8; font-size: 0.9rem; margin-top: 0.5rem;">
                            Category: ${auction.category.charAt(0).toUpperCase() + auction.category.slice(1).replace('-', ' ')}
                        </div>
                        <div class="bid-amount" style="margin-top: 0.5rem;">
                            Min Bid: ${minBidEth} ETH
                        </div>
                        <div style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem; line-height: 1.4;">
                            ${auction.description.substring(0, 120)}${auction.description.length > 120 ? '...' : ''}
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #94a3b8;">
                            Created: ${new Date(Number(auction.timestamp) * 1000).toLocaleDateString()}
                        </div>
                        ${!isSampleAuction ?
                            '<div style="font-size: 0.75rem; color: #86efac; margin-top: 0.25rem;">🔒 Real blockchain transactions</div>' :
                            '<div style="font-size: 0.75rem; color: #93c5fd; margin-top: 0.25rem;">📝 Simulated for testing</div>'
                        }
                    </div>
                `;
            }).join('');

            auctionsList.innerHTML = auctionsHtml;
        }

        function startBidding(auctionId) {
            currentAuctionId = auctionId;

            const auction = sampleAuctions.find(a => a.id === auctionId) || {
                id: auctionId,
                title: `Auction #${auctionId}`,
                description: "Auction details",
                minimumBid: ethers.parseEther("0.00001")
            };

            const minBidEth = auction.minimumBid ? ethers.formatEther(auction.minimumBid) : '0.00001';

            console.log('Starting bid for auction:', auctionId);
            console.log('Auction details:', auction);
            console.log('Is sample auction:', sampleAuctions.some(a => a.id === auctionId));

            // Check if this is a sample auction (always allow local bidding) or blockchain auction
            const isSampleAuction = auctionId <= 10 || sampleAuctions.some(a => a.id === auctionId);

            document.getElementById('auctionDetails').innerHTML = `
                <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h3 style="color: #fbbf24; margin-bottom: 0.5rem;">${auction.title}</h3>
                    <p style="color: #94a3b8; font-size: 0.9rem;">Minimum Bid: ${minBidEth} ETH</p>
                    '<p style="color: #64748b; font-size: 0.8rem; margin-top: 0.5rem;">🔒 FHE encrypted auction - confidential bids with real ETH</p>'
                </div>
            `;

            bidCard.style.display = 'block';
            bidCard.scrollIntoView({ behavior: 'smooth' });
        }

        async function placeBid() {
            try {
                if (!selectedBidAmount) {
                    throw new Error('Please select a bid amount');
                }
                if (!currentAuctionId) {
                    throw new Error('No auction selected for bidding');
                }
                if (!contract) {
                    throw new Error('Please connect your wallet first to place bids');
                }

                let bidAmountEth;
                if (selectedBidAmount === 'custom') {
                    bidAmountEth = document.getElementById('customBidAmount').value;
                    if (!bidAmountEth || parseFloat(bidAmountEth) <= 0) {
                        throw new Error('Please enter a valid custom bid amount');
                    }
                } else {
                    bidAmountEth = selectedBidAmount;
                }

                const comments = document.getElementById('bidComments').value || "No comments";
                const bidAmountWei = ethers.parseEther(bidAmountEth.toString());
                const isHighBid = parseFloat(bidAmountEth) >= 1.0;

                console.log('Placing bid for auction ID:', currentAuctionId);
                console.log('Bid amount:', bidAmountEth, 'ETH');
                console.log('Bid amount Wei:', bidAmountWei.toString());
                console.log('Is high bid:', isHighBid);
                console.log('Comments:', comments);

                // All auctions now use real MetaMask transactions
                console.log('Attempting real blockchain transaction for auction ID:', currentAuctionId);

                // Check if user has already bid
                try {
                    const hasAlreadyBid = await contract.hasPlacedBid(userAddress, currentAuctionId);
                    if (hasAlreadyBid) {
                        throw new Error('You have already placed a bid on this auction');
                    }
                } catch (error) {
                    if (error.message.includes('already placed a bid')) {
                        throw error;
                    }
                    console.log('Could not check bid status, proceeding with bid attempt...');
                }

                // Attempt real blockchain transaction
                showAlert('⏳ Submitting bid to blockchain...', 'info');

                const tx = await contract.placeBid(
                    currentAuctionId,
                    isHighBid,
                    bidAmountWei,
                    comments,
                    {
                        value: bidAmountWei
                    }
                );

                showAlert('🔄 Bid submitted! Waiting for confirmation...', 'success');
                console.log('Transaction hash:', tx.hash);

                const receipt = await tx.wait();

                if (receipt.status === 0) {
                    throw new Error('Transaction was reverted by the contract');
                }

                showAlert(`✅ Confidential bid of ${bidAmountEth} ETH placed successfully! Your bid is encrypted using FHE. Transaction: ${tx.hash.substring(0, 10)}...`, 'success');
                // Participation tracked automatically via blockchain contract
                resetBidForm();
                loadAuctions();

            } catch (error) {
                console.error('Error placing bid:', error);

                let errorMsg = error.message;
                if (error.message.includes('insufficient funds')) {
                    errorMsg = 'Insufficient funds to place this bid';
                } else if (error.message.includes('auction ended') || error.message.includes('Auction has ended')) {
                    errorMsg = 'This auction has ended and no longer accepts bids';
                } else if (error.message.includes('below minimum') || error.message.includes('Bid below minimum')) {
                    errorMsg = 'Bid amount is below the minimum required';
                } else if (error.message.includes('already placed a bid')) {
                    errorMsg = 'You have already placed a bid on this auction';
                } else if (error.message.includes('Cannot bid on your own auction')) {
                    errorMsg = 'You cannot bid on your own auction';
                } else if (error.message.includes('user rejected') || error.message.includes('User denied')) {
                    errorMsg = 'Transaction was rejected in MetaMask';
                }

                showAlert('❌ Failed to place bid: ' + errorMsg, 'error');
            }
        }

        function resetBidForm() {
            selectedBidAmount = null;
            currentAuctionId = null;
            bidCard.style.display = 'none';
            document.getElementById('bidComments').value = '';
            document.getElementById('customBidAmount').value = '';
            document.getElementById('customBidGroup').style.display = 'none';

            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertsContainer.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        connectWalletBtn.addEventListener('click', connectWallet);

        createAuctionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('auctionTitle').value;
            const description = document.getElementById('auctionDescription').value;
            const category = document.getElementById('auctionCategory').value;
            const minimumBid = parseFloat(document.getElementById('minimumBid').value);
            await createAuction(title, description, category, minimumBid);
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('option-button')) {
                const parent = e.target.parentElement;

                parent.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('selected');
                });

                e.target.classList.add('selected');

                if (e.target.dataset.bid) {
                    selectedBidAmount = e.target.dataset.bid;

                    if (selectedBidAmount === 'custom') {
                        document.getElementById('customBidGroup').style.display = 'block';
                    } else {
                        document.getElementById('customBidGroup').style.display = 'none';
                    }
                }
            }
        });

        document.getElementById('placeBidBtn').addEventListener('click', placeBid);
        document.getElementById('cancelBidBtn').addEventListener('click', resetBidForm);

        // Real-time form validation
        function setupFormValidation() {
            const titleInput = document.getElementById('auctionTitle');
            const descriptionInput = document.getElementById('auctionDescription');
            const categorySelect = document.getElementById('auctionCategory');
            const bidInput = document.getElementById('minimumBid');
            const submitBtn = document.getElementById('createAuctionBtn');

            function validateTitle() {
                const value = titleInput.value.trim();
                const errorEl = document.getElementById('titleError');
                const successEl = document.getElementById('titleSuccess');

                if (value.length < 3 || value.length > 100) {
                    titleInput.classList.add('error');
                    errorEl.style.display = 'flex';
                    successEl.style.display = 'none';
                    return false;
                } else {
                    titleInput.classList.remove('error');
                    errorEl.style.display = 'none';
                    successEl.style.display = 'flex';
                    return true;
                }
            }

            function validateDescription() {
                const value = descriptionInput.value.trim();
                const errorEl = document.getElementById('descriptionError');
                const successEl = document.getElementById('descriptionSuccess');

                if (value.length < 10 || value.length > 500) {
                    descriptionInput.classList.add('error');
                    errorEl.style.display = 'flex';
                    successEl.style.display = 'none';
                    return false;
                } else {
                    descriptionInput.classList.remove('error');
                    errorEl.style.display = 'none';
                    successEl.style.display = 'flex';
                    return true;
                }
            }

            function validateCategory() {
                const value = categorySelect.value;
                const errorEl = document.getElementById('categoryError');
                const successEl = document.getElementById('categorySuccess');

                if (!value) {
                    categorySelect.classList.add('error');
                    errorEl.style.display = 'flex';
                    successEl.style.display = 'none';
                    return false;
                } else {
                    categorySelect.classList.remove('error');
                    errorEl.style.display = 'none';
                    successEl.style.display = 'flex';
                    return true;
                }
            }

            function validateBid() {
                const value = parseFloat(bidInput.value);
                const errorEl = document.getElementById('bidError');
                const successEl = document.getElementById('bidSuccess');

                if (isNaN(value) || value < 0.00001 || value > 1000) {
                    bidInput.classList.add('error');
                    errorEl.style.display = 'flex';
                    successEl.style.display = 'none';

                    // Specific error messages
                    if (isNaN(value)) {
                        errorEl.innerHTML = '⚠️ Please enter a valid number';
                    } else if (value < 0.00001) {
                        errorEl.innerHTML = '⚠️ Minimum bid cannot be less than 0.00001 ETH';
                    } else if (value > 1000) {
                        errorEl.innerHTML = '⚠️ Maximum bid limit is 1000 ETH';
                    }

                    return false;
                } else {
                    bidInput.classList.remove('error');
                    errorEl.style.display = 'none';
                    successEl.style.display = 'flex';
                    return true;
                }
            }

            function validateForm() {
                const isValid = validateTitle() && validateDescription() && validateCategory() && validateBid();
                submitBtn.disabled = !isValid;
                return isValid;
            }

            // Add event listeners
            titleInput.addEventListener('input', validateForm);
            titleInput.addEventListener('blur', validateForm);
            descriptionInput.addEventListener('input', validateForm);
            descriptionInput.addEventListener('blur', validateForm);
            categorySelect.addEventListener('change', validateForm);
            bidInput.addEventListener('input', validateForm);
            bidInput.addEventListener('blur', validateForm);

            // Initial validation
            validateForm();
        }


        // Deploy all preset auctions to blockchain
        async function deployAllPresetAuctions() {
            try {
                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                // Verify contract exists and get network info
                const network = await provider.getNetwork();
                console.log('Current network:', network.name, 'Chain ID:', network.chainId);

                const code = await provider.getCode(CONTRACT_ADDRESS);
                console.log('Contract code length:', code.length);
                console.log('Contract code preview:', code.substring(0, 200) + '...');

                // Check for FHEVM-specific bytecode patterns
                const isFHEContract = code.includes('7465766d') || code.includes('54464845'); // Look for FHEVM/TFHE patterns
                console.log('Contains FHEVM patterns:', isFHEContract);

                if (code === '0x') {
                    throw new Error(`No contract found at address ${CONTRACT_ADDRESS} on ${network.name}. Please check the contract address and network.`);
                }

                // Check if this is the expected contract by testing a unique function
                console.log('Testing contract compatibility...');

                // Test a simple contract call first
                try {
                    const totalCounts = await contract.getTotalCounts();
                    console.log('Contract is functional - Total auctions:', totalCounts[0].toString(), 'Active:', totalCounts[1].toString());
                } catch (testError) {
                    console.error('Contract test call failed:', testError);
                    console.error('This might be a Simple contract, not FHE contract. Trying with Simple contract...');

                    // Try to switch back to Simple contract for compatibility
                    const SIMPLE_ABI = [
                        {
                            "inputs": [
                                {"internalType": "string", "name": "_title", "type": "string"},
                                {"internalType": "string", "name": "_description", "type": "string"},
                                {"internalType": "string", "name": "_category", "type": "string"},
                                {"internalType": "uint256", "name": "_minimumBid", "type": "uint256"}
                            ],
                            "name": "createAuction",
                            "outputs": [],
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "inputs": [],
                            "name": "getTotalCounts",
                            "outputs": [
                                {"internalType": "uint256", "name": "totalAuctionCount", "type": "uint256"},
                                {"internalType": "uint256", "name": "activeAuctionCount", "type": "uint256"}
                            ],
                            "stateMutability": "view",
                            "type": "function"
                        }
                    ];

                    try {
                        const tempContract = new ethers.Contract(CONTRACT_ADDRESS, SIMPLE_ABI, signer);
                        const simpleCounts = await tempContract.getTotalCounts();
                        console.log('✅ Using Simple contract - Total auctions:', simpleCounts[0].toString(), 'Active:', simpleCounts[1].toString());
                        // Update the global contract to use simple ABI
                        contract = tempContract;
                        console.log('✅ Contract switched to Simple ABI successfully');
                    } catch (simpleError) {
                        console.error('❌ Simple contract test also failed:', simpleError);
                        throw new Error(`Contract at ${CONTRACT_ADDRESS} is not responding to either FHE or Simple calls: ${simpleError.message}`);
                    }
                }

                const deployBtn = document.getElementById('deployAllBtn');
                const progressDiv = document.getElementById('deployProgress');
                const statusSpan = document.getElementById('deployStatus');
                const progressBar = document.getElementById('deployProgressBar');
                const countSpan = document.getElementById('deployCount');
                const totalSpan = document.getElementById('deployTotal');

                // Show progress UI
                deployBtn.disabled = true;
                deployBtn.textContent = '🔄 Deploying...';
                progressDiv.style.display = 'block';

                const totalAuctions = sampleAuctions.length;
                totalSpan.textContent = totalAuctions;

                let deployedCount = 0;
                const deployedAuctions = [];

                for (let i = 0; i < sampleAuctions.length; i++) {
                    const auction = sampleAuctions[i];

                    try {
                        statusSpan.textContent = `Deploying: ${auction.title.substring(0, 30)}...`;
                        console.log(`Deploying auction ${i + 1}:`, auction.title);
                        console.log('Auction data:', {
                            title: auction.title,
                            description: auction.description,
                            category: auction.category,
                            minimumBid: auction.minimumBid
                        });

                        // Use the minimum bid (already in Wei format from sampleAuctions)
                        const minBidWei = auction.minimumBid;
                        console.log('Minimum bid in Wei:', minBidWei.toString());
                        console.log('Minimum bid type:', typeof minBidWei);

                        // Validate parameters before gas estimation
                        console.log('Validating parameters:');
                        console.log('- Title length:', auction.title.length);
                        console.log('- Description length:', auction.description.length);
                        console.log('- Category:', auction.category);
                        console.log('- MinBid > 0:', minBidWei > 0n);

                        // Test basic contract functionality first
                        try {
                            const totalCounts = await contract.getTotalCounts();
                            console.log('Contract is responsive. Current auctions:', totalCounts[0].toString());
                        } catch (testError) {
                            console.error('Contract not responsive:', testError.message);
                            throw new Error('Contract connectivity issue');
                        }

                        // FHE contracts need higher gas limits for encrypted operations
                        let gasEstimate;
                        try {
                            gasEstimate = await contract.createAuction.estimateGas(
                                auction.title,
                                auction.description,
                                auction.category,
                                minBidWei
                            );
                            console.log(`Gas estimate for auction ${i + 1}:`, gasEstimate.toString());
                        } catch (gasError) {
                            console.warn(`Gas estimation failed for auction ${i + 1}:`, gasError.message);
                            console.warn('Detailed gas error:', gasError);
                            console.warn('Using higher default gas limit for FHE operations');
                            gasEstimate = 2000000n; // Higher gas limit for FHE operations
                        }

                        // Submit transaction with higher gas limit for FHE
                        const tx = await contract.createAuction(
                            auction.title,
                            auction.description,
                            auction.category,
                            minBidWei,
                            {
                                gasLimit: gasEstimate ? Math.floor(Number(gasEstimate) * 2) : 2000000,
                                gasPrice: ethers.parseUnits("20", "gwei") // Specify gas price
                            }
                        );

                        statusSpan.textContent = `Waiting for confirmation: ${auction.title.substring(0, 25)}...`;
                        console.log(`Transaction submitted for auction ${i + 1}:`, tx.hash);

                        const receipt = await tx.wait();

                        if (receipt.status === 0) {
                            throw new Error('Transaction reverted');
                        }

                        deployedCount++;
                        countSpan.textContent = deployedCount;
                        progressBar.style.width = `${(deployedCount / totalAuctions) * 100}%`;

                        // Store deployment info
                        deployedAuctions.push({
                            originalId: auction.id,
                            txHash: tx.hash,
                            blockNumber: receipt.blockNumber,
                            title: auction.title
                        });

                        console.log(`✅ Auction ${i + 1} deployed successfully in block ${receipt.blockNumber}`);
                        statusSpan.textContent = `✅ Deployed: ${auction.title.substring(0, 25)}`;

                        // Small delay to avoid overwhelming the network
                        await new Promise(resolve => setTimeout(resolve, 1000));

                    } catch (error) {
                        console.error(`❌ Failed to deploy auction ${i + 1}:`, error);
                        console.error('Error details:', {
                            message: error.message,
                            code: error.code,
                            data: error.data,
                            reason: error.reason
                        });

                        // FHE-specific error analysis
                        if (error.message.includes('transaction execution reverted') || error.message.includes('missing revert data')) {
                            console.log('🔍 FHE Contract Analysis:');
                            console.log('- This appears to be an old FHE contract version incompatibility');
                            console.log('- Contract at', CONTRACT_ADDRESS, 'was compiled with older TFHE version');
                            console.log('- Gas estimation failing suggests TFHE.asEuint64(0) initialization issue');
                            console.log('- Recommendation: Deploy updated FHE contract with fixed dependencies');
                            console.log('- Or switch to Simple contract for immediate compatibility');

                            // Suggest automatic fallback
                            console.log('🔄 Consider switching to Simple contract for testing...');
                        }

                        // Check if it's a specific contract error
                        if (error.message.includes('Title cannot be empty')) {
                            statusSpan.textContent = `❌ Failed: Empty title`;
                            console.error('Auction title:', auction.title);
                        } else if (error.message.includes('Description cannot be empty')) {
                            statusSpan.textContent = `❌ Failed: Empty description`;
                            console.error('Auction description:', auction.description);
                        } else if (error.message.includes('Category cannot be empty')) {
                            statusSpan.textContent = `❌ Failed: Empty category`;
                            console.error('Auction category:', auction.category);
                        } else if (error.message.includes('Minimum bid must be greater than 0')) {
                            statusSpan.textContent = `❌ Failed: Invalid minimum bid`;
                            console.error('Minimum bid:', minBidWei.toString());
                        } else {
                            statusSpan.textContent = `❌ Failed: ${auction.title.substring(0, 25)}`;
                        }

                        // Continue with next auction even if one fails
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }

                // Deployment complete
                if (deployedCount > 0) {
                    statusSpan.textContent = `🎉 Deployment complete! ${deployedCount}/${totalAuctions} auctions deployed`;
                    progressBar.style.width = '100%';

                    showAlert(`🎉 Successfully deployed ${deployedCount} auctions to blockchain!`, 'success');

                    // Fetch updated auctions from blockchain
                    setTimeout(async () => {
                        try {
                            await loadAuctions();
                            showAlert('Auction list updated with blockchain auctions!', 'success');
                        } catch (error) {
                            console.error('Error loading updated auctions:', error);
                        }
                    }, 2000);

                    // Hide deploy section after successful deployment
                    setTimeout(() => {
                        document.getElementById('deploySection').style.display = 'none';
                    }, 5000);

                } else {
                    statusSpan.textContent = '❌ No auctions were successfully deployed';
                    showAlert('❌ Deployment failed. Please check your wallet and try again.', 'error');
                }

            } catch (error) {
                console.error('Deployment error:', error);
                showAlert('Deployment failed: ' + error.message, 'error');
            } finally {
                // Reset UI
                const deployBtn = document.getElementById('deployAllBtn');
                const progressDiv = document.getElementById('deployProgress');

                deployBtn.disabled = false;
                deployBtn.textContent = '🚀 Deploy All Preset Auctions to Blockchain';

                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Test contract basic functionality
        async function testContract() {
            try {
                if (!provider) {
                    throw new Error('Please connect your wallet first');
                }

                console.log('🧪 Testing contract at:', CONTRACT_ADDRESS);

                // First check if contract exists
                const code = await provider.getCode(CONTRACT_ADDRESS);
                console.log('Contract code length:', code.length);

                if (code === '0x') {
                    throw new Error(`❌ No contract found at address ${CONTRACT_ADDRESS}. Please check the address.`);
                }

                console.log('✅ Contract exists at address');

                // Try to determine contract type by testing different ABIs
                console.log('Testing different contract ABIs...');

                // Test Simple contract ABI first
                const SIMPLE_ABI = [
                    {
                        "inputs": [],
                        "name": "getTotalCounts",
                        "outputs": [
                            {"internalType": "uint256", "name": "totalAuctionCount", "type": "uint256"},
                            {"internalType": "uint256", "name": "activeAuctionCount", "type": "uint256"}
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "getActiveAuctions",
                        "outputs": [
                            {
                                "components": [
                                    {"internalType": "uint256", "name": "id", "type": "uint256"},
                                    {"internalType": "string", "name": "title", "type": "string"},
                                    {"internalType": "string", "name": "description", "type": "string"},
                                    {"internalType": "string", "name": "category", "type": "string"},
                                    {"internalType": "uint256", "name": "minimumBid", "type": "uint256"},
                                    {"internalType": "address", "name": "creator", "type": "address"},
                                    {"internalType": "uint256", "name": "timestamp", "type": "uint256"},
                                    {"internalType": "bool", "name": "isActive", "type": "bool"},
                                    {"internalType": "uint256", "name": "endTime", "type": "uint256"},
                                    {"internalType": "uint256", "name": "highestBidAmount", "type": "uint256"},
                                    {"internalType": "address", "name": "highestBidder", "type": "address"},
                                    {"internalType": "uint256", "name": "bidCount", "type": "uint256"}
                                ],
                                "internalType": "struct ConfidentialAuctionSimple.Auction[]",
                                "name": "",
                                "type": "tuple[]"
                            }
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    }
                ];

                try {
                    const simpleContract = new ethers.Contract(CONTRACT_ADDRESS, SIMPLE_ABI, provider);
                    const totalCounts = await simpleContract.getTotalCounts();
                    console.log('✅ Simple contract works! Total auctions:', totalCounts[0].toString(), 'Active:', totalCounts[1].toString());

                    const activeAuctions = await simpleContract.getActiveAuctions();
                    console.log('✅ getActiveAuctions works, count:', activeAuctions.length);

                    showAlert('✅ Contract is ConfidentialAuctionSimple and working!', 'success');
                    return;
                } catch (simpleError) {
                    console.log('❌ Simple contract ABI failed:', simpleError.message);
                }

                // If simple contract fails, the contract might not be what we expect
                throw new Error('Contract exists but does not match expected ABI. Wrong contract deployed?');

            } catch (error) {
                console.error('❌ Contract test failed:', error);
                showAlert('❌ Contract test failed: ' + error.message, 'error');
            }
        }

        // Full contract diagnosis
        async function fullDiagnosis() {
            try {
                if (!provider) {
                    throw new Error('Please connect your wallet first');
                }

                console.log('🔍 Starting full contract diagnosis...');
                console.log('Contract address:', CONTRACT_ADDRESS);

                // Step 1: Check network
                const network = await provider.getNetwork();
                console.log('✅ Network:', network.name, 'Chain ID:', network.chainId);

                // Step 2: Check contract exists
                const code = await provider.getCode(CONTRACT_ADDRESS);
                console.log('Contract bytecode length:', code.length);
                console.log('Contract bytecode preview:', code.substring(0, 200));

                if (code === '0x') {
                    console.log('❌ NO CONTRACT FOUND AT ADDRESS!');
                    showAlert('❌ No contract found at the specified address!', 'error');
                    return;
                }

                console.log('✅ Contract exists');

                // Step 3: Check account balance
                const balance = await provider.getBalance(userAddress);
                console.log('Account balance:', ethers.formatEther(balance), 'ETH');

                if (balance < ethers.parseEther("0.001")) {
                    console.log('⚠️ Low balance detected');
                    showAlert('⚠️ Low ETH balance detected', 'warning');
                }

                // Step 4: Test different function signatures
                console.log('Testing function signatures...');

                // Try getTotalCounts with minimal ABI
                const minimalABI = [
                    {
                        "inputs": [],
                        "name": "getTotalCounts",
                        "outputs": [
                            {"internalType": "uint256", "name": "", "type": "uint256"},
                            {"internalType": "uint256", "name": "", "type": "uint256"}
                        ],
                        "stateMutability": "view",
                        "type": "function"
                    }
                ];

                try {
                    const testContract = new ethers.Contract(CONTRACT_ADDRESS, minimalABI, provider);
                    const counts = await testContract.getTotalCounts();
                    console.log('✅ getTotalCounts works:', counts[0].toString(), counts[1].toString());
                } catch (error) {
                    console.log('❌ getTotalCounts failed:', error.message);
                }

                // Step 5: Try createAuction with estimation
                const createAuctionABI = [
                    {
                        "inputs": [
                            {"internalType": "string", "name": "_title", "type": "string"},
                            {"internalType": "string", "name": "_description", "type": "string"},
                            {"internalType": "string", "name": "_category", "type": "string"},
                            {"internalType": "uint256", "name": "_minimumBid", "type": "uint256"}
                        ],
                        "name": "createAuction",
                        "outputs": [],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    }
                ];

                try {
                    const signer = await provider.getSigner();
                    const testContract = new ethers.Contract(CONTRACT_ADDRESS, createAuctionABI, signer);

                    const gasEstimate = await testContract.createAuction.estimateGas(
                        "Test",
                        "Test Description",
                        "test",
                        ethers.parseEther("0.00001")
                    );
                    console.log('✅ createAuction gas estimate works:', gasEstimate.toString());
                    showAlert('✅ Contract diagnosis complete - createAuction should work!', 'success');
                } catch (error) {
                    console.log('❌ createAuction estimation failed:', error);
                    console.log('Error code:', error.code);
                    console.log('Error reason:', error.reason);
                    console.log('Error data:', error.data);

                    if (error.message.includes('missing revert data')) {
                        showAlert('❌ Contract function not found or incompatible', 'error');
                    } else {
                        showAlert('❌ Contract error: ' + error.message, 'error');
                    }
                }

            } catch (error) {
                console.error('❌ Diagnosis failed:', error);
                showAlert('❌ Diagnosis failed: ' + error.message, 'error');
            }
        }

        // Test single auction deployment
        async function testSingleAuction() {
            try {
                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                console.log('🎯 Testing single auction deployment...');

                const testAuction = {
                    title: "Test Auction",
                    description: "Test Description",
                    category: "test",
                    minimumBid: ethers.parseEther("0.00001")
                };

                console.log('Test auction data:', testAuction);

                // Try gas estimation
                console.log('Estimating gas...');
                const gasEstimate = await contract.createAuction.estimateGas(
                    testAuction.title,
                    testAuction.description,
                    testAuction.category,
                    testAuction.minimumBid
                );
                console.log('✅ Gas estimate successful:', gasEstimate.toString());

                // Try actual transaction
                console.log('Submitting transaction...');
                const tx = await contract.createAuction(
                    testAuction.title,
                    testAuction.description,
                    testAuction.category,
                    testAuction.minimumBid,
                    {
                        gasLimit: Math.floor(Number(gasEstimate) * 1.5)
                    }
                );

                console.log('Transaction submitted:', tx.hash);
                const receipt = await tx.wait();
                console.log('✅ Transaction confirmed in block:', receipt.blockNumber);

                showAlert('✅ Test auction created successfully!', 'success');
                loadAuctions(); // Refresh auctions list

            } catch (error) {
                console.error('❌ Single auction test failed:', error);
                showAlert('❌ Single auction test failed: ' + error.message, 'error');
            }
        }

        async function deployNewFHEContract() {
            try {
                if (!signer) {
                    throw new Error('Please connect your wallet first');
                }

                console.log('🚀 Deploying new FHE contract with updated dependencies...');

                // New FHE contract bytecode (compiled with FHE v0.7.0)
                const contractBytecode = "0x608060405260016004555f600555348015610018575f80fd5b5061211b806100265f395ff3fe6080604052600436106100ea575f3560e01c8063a65ed0d611610083578063cf44b5d511610055578063cf44b5d5146102cf578063db2e21bc146102f0578063fc52848214610304578063ff3ad0b41461031957005b8063a65ed0d614610229578063b4fbe80a14610272578063b9a2de3a14610291578063c75c99e6146102b057005b8063571a26a0116100bc578063571a26a0146101765780635f93de49146101ad57806375b6a06e146101de57806378bd7935146101fd57005b8063045af334146100f357806316002f4a146101215780632158d95a146101445780633f40efdc1461016357005b366100f157005b005b3480156100fe575f80fd5b50610107610345565b604080519283526020830191909152015b60405180910390f35b34801561012c575f80fd5b5061013660055481565b604051908152602001610118565b34801561014f575f80fd5b5061013661015e3660046119e0565b6103ab565b6100f1610171366004611a94565b6103f6565b348015610181575f80fd5b506101956101903660046119e0565b6107c3565b6040516101189c9b9a99989796959493929190611b3a565b3480156101b8575f80fd5b506101cc6101c7366004611bca565b6109c3565b60405161011896959493929190611bea565b3480156101e9575f80fd5b506100f16101f8366004611c30565b610aa9565b348015610208575f80fd5b5061021c6102173660046119e0565b610dd8565b6040516101189190611d90565b348015610234575f80fd5b50610262610243366004611dbd565b600360209081525f928352604080842090915290825290205460ff1681565b6040519015158152602001610118565b34801561027d575f80fd5b5061013661028c366004611dbd565b611046565b34801561029c575f80fd5b506100f16102ab3660046119e0565b611071565b3480156102bb575f80fd5b506102626102ca366004611dbd565b61125a565b3480156102da575f80fd5b506102e3611287565b6040516101189190611de5565b3480156102fb575f80fd5b506100f16115ed565b34801561030f575f80fd5b5061013660045481565b348015610324575f80fd5b50610338610333366004611e47565b611668565b6040516101189190611e60565b5f808060015b60045481101561039f575f8181526020819052604090206007015460ff16801561038457505f8181526020819052604090206008015442105b15610397578161039381611eb7565b9250505b60010161034b565b50600554939092509050565b5f80821180156103bc575060045482105b6103e15760405162461bcd60e51b81526004016103d890611ecf565b60405180910390fd5b505f908152602081905260409020600b015490565b5f84118015610406575060045484105b6104225760405162461bcd60e51b81526004016103d890611ecf565b5f8481526020819052604090206007015460ff1661047a5760405162461bcd60e51b815260206004820152601560248201527441756374696f6e206973206e6f742061637469766560581b60448201526064016103d8565b5f8481526020819052604090206008015442106104cd5760405162461bcd60e51b8152602060048201526011602482015270105d58dd1a5bdb881a185cc8195b991959607a1b60448201526064016103d8565b5f848152602081905260409020600501546001600160a01b031633036105355760405162461bcd60e51b815260206004820152601e60248201527f43616e6e6f7420626964206f6e20796f7572206f776e2061756374696f6e000060448201526064016103d8565b335f90815260036020908152604080832087845290915290205460ff16156105b55760405162461bcd60e51b815260206004820152602d60248201527f596f75206861766520616c726561647920706c61636564206120626964206f6e60448201526c103a3434b99030bab1ba34b7b760991b60648201526084016103d8565b5f848152602081905260409020600401543410156106155760405162461bcd60e51b815260206004820152601860248201527f4269642062656c6f77206d696e696d756d20616d6f756e74000000000000000060448201526064016103d8565b5f61061f846116d1565b90505f61062b846116ec565b5f878152600160208181526040808420815160c081018352338152808401878152928101898152606082018b815242608084015260a083018890528354808801855593885294909620815160069093020180546001600160a01b0319166001600160a01b039093169290921782559151938101939093559251600283015551929350909160038201906106be9082611f7f565b506080820151600482015560a0909101516005909101805460ff19169115159190911790555f868152602081905260408120600b018054916106ff83611eb7565b9091555050335f9081526003602090815260408083208984528252808320805460ff19166001179055908290528120600901549061073d8383611702565b905061074a818484611737565b5f898152602081905260409020600901558515610782575f888152602081905260409020600a0180546001600160a01b031916331790555b604051428152339089907f0e54eff26401bf69b81b26f60bd85ef47f5d85275c1d268d84f68d6897431c479060200160405180910390a35050505050505050565b5f60208190529081526040902080546001820180549192916107e490611efb565b80601f016020809104026020016040519081016040528092919081815260200182805461081090611efb565b801561085b5780601f106108325761010080835404028352916020019161085b565b820191905f5260205f20905b81548152906001019060200180831161083e57829003601f168201915b50505050509080600201805461087090611efb565b80601f016020809104026020016040519081016040528092919081815260200182805461089c90611efb565b80156108e75780601f106108be576101008083540402835291602001916108e7565b820191905f5260205f20905b8154815290600101906020018083116108ca57829003601f168201915b5050505050908060030180546108fc90611efb565b80601f016020809104026020016040519081016040528092919081815260200182805461092890611efb565b80156109735780601f1061094a57610100808354040283529160200191610973565b820191905f5260205f20905b81548152906001019060200180831161095657829003601f168201915b505050600484015460058501546006860154600787015460088801546009890154600a8a0154600b909a0154989995986001600160a01b03958616985093965060ff90921694909391929116908c565b6001602052815f5260405f2081815481106109dc575f80fd5b5f91825260209091206006909102018054600182015460028301546003840180546001600160a01b0390941696509194509291610a1890611efb565b80601f0160208091040260200160405190810160405280929190818152602001828054610a4490611efb565b8015610a8f5780601f10610a6657610100808354040283529160200191610a8f565b820191905f5260205f20905b815481529060010190602001808311610a7257829003601f168201915b50505050600483015460059093015191929160ff16905086565b5f845111610af15760405162461bcd60e51b81526020600482015260156024820152745469746c652063616e6e6f7420626520656d70747960581b60448201526064016103d8565b5f835111610b415760405162461bcd60e51b815260206004820152601b60248201527f4465736372697074696f6e2063616e6e6f7420626520656d707479000000000060448201526064016103d8565b5f825111610b915760405162461bcd60e51b815260206004820152601860248201527f43617465676f72792063616e6e6f7420626520656d707479000000000000000060448201526064016103d8565b5f8111610beb5760405162461bcd60e51b815260206004820152602260248201527f4d696e696d756d20626964206d7573742062652067726561746572207468616e604482015261020360f41b60648201526084016103d8565b600480545f9182610bfb83611eb7565b9091555090505f610c0f4262093a8061203f565b9050604051806101800160405280838152602001878152602001868152602001858152602001848152602001336001600160a01b03168152602001428152602001600115158152602001828152602001610c685f6116ec565b81525f6020808301829052604092830182905285825281815291902082518155908201516001820190610c9b9082611f7f565b5060408201516002820190610cb09082611f7f565b5060608201516003820190610cc59082611f7f565b506080820151600482015560a0820151600580830180546001600160a01b039384166001600160a01b03199182161790915560c0850151600685015560e085015160078501805491151560ff1990921691909117905561010085015160088501556101208501516009850155610140850151600a850180549190941691161790915561016090920151600b90910155335f908152600260209081526040822080546001810182559083529082200184905581549190610d8383611eb7565b9190505550336001600160a01b0316827f7ee613409a3818be8eb068049ae12d5fa12b0bb8b240a3f0488a0d2509c9fc7d88878786604051610dc89493929190612052565b60405180910390a3505050505050565b610de0611971565b5f82118015610df0575060045482105b610e0c5760405162461bcd60e51b81526004016103d890611ecf565b5f828152602081815260409182902082516101808101909352805483526001810180549192840191610e3d90611efb565b80601f0160208091040260200160405190810160405280929190818152602001828054610e6990611efb565b8015610eb45780601f10610e8b57610100808354040283529160200191610eb4565b820191905f5260205f20905b815481529060010190602001808311610e9757829003601f168201915b50505050508152602001600282018054610ecd90611efb565b80601f0160208091040260200160405190810160405280929190818152602001828054610ef990611efb565b8015610f445780601f10610f1b57610100808354040283529160200191610f44565b820191905f5260205f20905b815481529060010190602001808311610f2757829003601f168201915b50505050508152602001600382018054610f5d90611efb565b80601f0160208091040260200160405190810160405280929190818152602001828054610f8990611efb565b8015610fd45780601f10610fab57610100808354040283529160200191610fd4565b820191905f5260205f20905b815481529060010190602001808311610fb757829003601f168201915b50505091835250506004820154602082015260058201546001600160a01b03908116604083015260068301546060830152600783015460ff1615156080830152600883015460a0830152600983015460c0830152600a8301541660e0820152600b909101546101009091015292915050565b6002602052815f5260405f20818154811061105f575f80fd5b905f5260205f20015f91509150505481565b5f81118015611081575060045481105b61109d5760405162461bcd60e51b81526004016103d890611ecf565b5f8181526020819052604090206007015460ff166110f55760405162461bcd60e51b815260206004820152601560248201527441756374696f6e206973206e6f742061637469766560581b60448201526064016103d8565b5f818152602081905260409020600801544210158061112c57505f818152602081905260409020600501546001600160a01b031633145b6111965760405162461bcd60e51b815260206004820152603560248201527f41756374696f6e20686173206e6f7420656e6465642079657420616e6420796f6044820152743a9030b932903737ba103a34329031b932b0ba37b960591b60648201526084016103d8565b5f81815260208190526040902060078101805460ff19169055600a01546001600160a01b03168015611256575f828152602081905260408082206004810154600590910154915190926001600160a01b039092169183156108fc02918491818181858888f1935050505015801561120f573d5f803e3d5ffd5b50604080516001600160a01b03841681526020810183905284917fd2aa34a4fdbbc6dff6a3e56f46e0f3ae2a31d7785ff3487aa5c95c642acea501910160405180910390a2505b5050565b6001600160a01b0382165f90815260036020908152604080832084845290915290205460ff165b92915050565b60605f60015b6004548110156112e1575f8181526020819052604090206007015460ff1680156112c657505f8181526020819052604090206008015442105b156112d957816112d581611eb7565b9250505b60010161128d565b505f8167ffffffffffffffff8111156112fc576112fc6119f7565b60405190808252806020026020018201604052801561133557816020015b611322611971565b81526020019060019003908161131a5790505b5090505f60015b6004548110156115e4575f8181526020819052604090206007015460ff16801561137557505f8181526020819052604090206008015442105b156115dc575f8181526020818152604091829020825161018081019093528054835260018101805491928401916113ab90611efb565b80601f01602080910402602001604051908101604052809291908181526020018280546113d790611efb565b80156114225780601f106113f957610100808354040283529160200191611422565b820191905f5260205f20905b81548152906001019060200180831161140557829003601f168201915b5050505050815260200160028201805461143b90611efb565b80601f016020809104026020016040519081016040528092919081815260200182805461146790611efb565b80156114b25780601f10611489576101008083540402835291602001916114b2565b820191905f5260205f20905b81548152906001019060200180831161149557829003601f168201915b505050505081526020016003820180546114cb90611efb565b80601f01602080910402602001604051908101604052809291908181526020018280546114f790611efb565b80156115425780601f1061151957610100808354040283529160200191611542565b820191905f5260205f20905b81548152906001019060200180831161152557829003601f168201915b50505091835250506004820154602082015260058201546001600160a01b03908116604083015260068301546060830152600783015460ff1615156080830152600883015460a0830152600983015460c0830152600a8301541660e0820152600b909101516101009091015283518490849081106115c2576115c261208a565b602002602001018190525081806115d890611eb7565b9250505b60010161133c565b50909392505050565b33301461163c5760405162461bcd60e51b815260206004820152601a60248201527f4f6e6c7920636f6e74726163742063616e20776974686472617700000000000060448201526064016103d8565b60405133904780156108fc02915f818181858888f19350505050158015611665573d5f803e3d5ffd5b50565b6001600160a01b0381165f908152600260209081526040918290208054835181840281018401909452808452606093928301828280156116c557602002820191905f5260205f20905b8154815260200190600101908083116116b1575b50505050509050919050565b5f611281826116e0575f6116e3565b60015b60ff165f61174b565b5f6112818267ffffffffffffffff16600561174b565b5f82611714576117115f6116ec565b92505b81611725576117225f6116ec565b91505b61173083835f611800565b9392505050565b5f6117438484846118c8565b949350505050565b7fed8d60e34876f751cc8b014c560745351147d9de11b9347c854e881b128ea60154604051639cd07acb60e01b81525f917fed8d60e34876f751cc8b014c560745351147d9de11b9347c854e881b128ea600916001600160a01b0390911690639cd07acb906117c0908790879060040161209e565b6020604051808303815f875af11580156117dc573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061174391906120ce565b5f8082156118135750600160f81b611816565b505f5b5f7fed8d60e34876f751cc8b014c560745351147d9de11b9347c854e881b128ea60060018101546040516385362ee760e01b815260048101899052602481018890526001600160f81b0319851660448201529192506001600160a01b0316906385362ee7906064016020604051808303815f875af115801561189a573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906118be91906120ce565b9695505050505050565b5f807fed8d60e34876f751cc8b014c560745351147d9de11b9347c854e881b128ea6006001810154604051637702dcff60e01b81526004810188905260248101879052604481018690529192506001600160a01b031690637702dcff906064016020604051808303815f875af1158015611944573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061196891906120ce565b95945050505050565b6040518061018001604052805f81526020016060815260200160608152602001606081526020015f81526020015f6001600160a01b031681526020015f81526020015f151581526020015f81526020015f80191681526020015f6001600160a01b031681526020015f81525090565b5f602082840312156119f0575f80fd5b5035919050565b634e487b7160e01b5f52604160045260245ffd5b5f82601f830112611a1a575f80fd5b813567ffffffffffffffff80821115611a3557611a356119f7565b604051601f8301601f19908116603f01168101908282118183101715611a5d57611a5d6119f7565b81604052838152866020858801011115611a75575f80fd5b836020870160208301375f602085830101528094505050505092915050565b5f805f8060808587031215611aa7575f80fd5b8435935060208501358015158114611abd575f80fd5b925060408501359150606085013567ffffffffffffffff811115611adf575f80fd5b611aeb87828801611a0b565b91505092959194509250565b5f81518084525f5b81811015611b1b57602081850181015186830182015201611aff565b505f602082860101526020601f19601f83011685010191505092915050565b5f6101808e8352806020840152611b538184018f611af7565b90508281036040840152611b67818e611af7565b90508281036060840152611b7b818d611af7565b608084019b909b5250506001600160a01b0397881660a082015260c081019690965293151560e08601526101008501929092526101208401529092166101408201526101600152949350505050565b5f8060408385031215611bdb575f80fd5b50508035926020909101359150565b60018060a01b038716815285602082015284604082015260c060608201525f611c1660c0830186611af7565b60808301949094525090151560a090910152949350505050565b5f805f8060808587031215611c43575f80fd5b843567ffffffffffffffff80821115611c5a575f80fd5b611c6688838901611a0b565b95506020870135915080821115611c7b575f80fd5b611c8788838901611a0b565b94506040870135915080821115611c9c575f80fd5b50611ca987828801611a0b565b949793965093946060013593505050565b5f610180825184526020830151816020860152611cd982860182611af7565b91505060408301518482036040860152611cf38282611af7565b91505060608301518482036060860152611d0d8282611af7565b9150506080830151608085015260a0830151611d3460a08601826001600160a01b03169052565b5060c083015160c085015260e0830151611d5260e086018215159052565b5061010083810151908501526101208084015190850152610140808401516001600160a01b0316908501526101609283015192909301919091525090565b602081525f6117306020830184611cba565b80356001600160a01b0381168114611db8575f80fd5b919050565b5f8060408385031215611dce575f80fd5b611dd783611da2565b946020939093013593505050565b5f60208083016020845280855180835260408601915060408160051b8701019250602087015f5b82811015611e3a57603f19888603018452611e28858351611cba565b94509285019290850190600101611e0c565b5092979650505050505050565b5f60208284031215611e57575f80fd5b61173082611da2565b602080825282518282018190525f9190848201906040850190845b81811015611e9757835183529284019291840191600101611e7b565b50909695505050505050565b634e487b7160e01b5f52601160045260245ffd5b5f60018201611ec857611ec8611ea3565b5060010190565b602080825260129082015271125b9d985b1a5908185d58dd1a5bdb88125160721b604082015260600190565b600181811c90821680611f0f57607f821691505b602082108103611f2d57634e487b7160e01b5f52602260045260245ffd5b50919050565b601f821115611f7a57805f5260205f20601f840160051c81016020851015611f585750805b601f840160051c820191505b81811015611f77575f8155600101611f64565b50505b505050565b815167ffffffffffffffff811115611f9957611f996119f7565b611fad81611fa78454611efb565b84611f33565b602080601f831160018114611fe0575f8415611fc95750858301515b5f19600386901b1c1916600185901b178555612037565b5f85815260208120601f198616915b8281101561200e57888601518255948401946001909101908401611fef565b508582101561202b57878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b8082018082111561128157611281611ea3565b608081525f6120646080830187611af7565b82810360208401526120768187611af7565b604084019590955250506060015292915050565b634e487b7160e01b5f52603260045260245ffd5b82815260408101605483106120c157634e487b7160e01b5f52602160045260245ffd5b8260208301529392505050565b5f602082840312156120de575f80fd5b505191905056fea26469706673582212205153b69564750ccdb89832991e49782aa50c4a202f77b273f19a2fc1c3c8290564736f6c63430008180033";

                const deployBtn = document.getElementById('deployNewFHEBtn');
                deployBtn.disabled = true;
                deployBtn.textContent = '🔄 Deploying...';

                console.log('Estimating gas for contract deployment...');
                const gasEstimate = await provider.estimateGas({
                    data: contractBytecode
                });
                console.log('Gas estimate:', gasEstimate.toString());

                console.log('Submitting deployment transaction...');
                const deployTx = await signer.sendTransaction({
                    data: contractBytecode,
                    gasLimit: Math.floor(Number(gasEstimate) * 1.2), // 20% buffer
                    gasPrice: ethers.parseUnits("20", "gwei")
                });

                console.log('Deployment transaction hash:', deployTx.hash);
                console.log('Waiting for confirmation...');

                const receipt = await deployTx.wait();

                if (receipt.status === 0) {
                    throw new Error('Contract deployment failed');
                }

                const newContractAddress = receipt.contractAddress;
                console.log('✅ New FHE contract deployed successfully!');
                console.log('New contract address:', newContractAddress);

                // Update the contract address in the frontend
                const confirmation = confirm(`✅ New FHE contract deployed successfully!

Address: ${newContractAddress}

Do you want to switch to use this new contract?`);

                if (confirmation) {
                    // Update the global contract address and recreate contract instance
                    window.location.hash = `contract=${newContractAddress}`;

                    // Update README with new address for future reference
                    console.log(`📝 Update README.md with new contract address: ${newContractAddress}`);

                    // Reload page to use new contract
                    window.location.reload();
                }

            } catch (error) {
                console.error('❌ Failed to deploy new FHE contract:', error);
                alert(`Failed to deploy new FHE contract: ${error.message}`);
            } finally {
                const deployBtn = document.getElementById('deployNewFHEBtn');
                deployBtn.disabled = false;
                deployBtn.textContent = '🚀 Deploy New FHE Contract';
            }
        }

        async function testFHEIssue() {
            try {
                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                console.log('🧪 Testing FHE contract compatibility...');
                console.log('Current contract address:', CONTRACT_ADDRESS);

                // Test 1: Basic contract calls
                console.log('\n1. Testing basic contract functions...');
                try {
                    const totalCounts = await contract.getTotalCounts();
                    console.log('✅ getTotalCounts works:', totalCounts[0].toString(), 'total,', totalCounts[1].toString(), 'active');
                } catch (error) {
                    console.log('❌ getTotalCounts failed:', error.message);
                }

                // Test 2: Check if this is actually an FHE contract or simple contract
                console.log('\n2. Testing contract type...');
                const code = await provider.getCode(CONTRACT_ADDRESS);
                console.log('Contract bytecode length:', code.length);

                // Check for FHE-specific patterns
                const hasFHEPatterns = code.includes('ed8d60e34876f751cc8b014c560745351147d9de11b9347c854e881b128ea6015');
                console.log('Contains FHE patterns:', hasFHEPatterns);

                if (hasFHEPatterns) {
                    console.log('🔍 This is an FHE contract, but Sepolia may not support FHE operations');
                    console.log('🎯 SOLUTION: FHE contracts need Zama devnet or FHE-enabled networks');
                    console.log('💡 Recommendation: Use Simple contract for Sepolia testing');

                    alert(`❌ FHE Contract Issue Detected

This is a full FHE contract, but Sepolia testnet doesn't support FHE operations.

Solutions:
1. Deploy to Zama devnet for full FHE support
2. Use Simple contract version for Sepolia testing

The FHE operations (FHE.asEuint64) fail on standard Ethereum networks.`);
                } else {
                    console.log('✅ This appears to be a standard contract');
                }

                // Test 3: Try minimal createAuction to pinpoint failure
                console.log('\n3. Testing createAuction gas estimation...');
                try {
                    const gasEstimate = await contract.createAuction.estimateGas(
                        "Test",
                        "Test Description",
                        "test",
                        ethers.parseEther("0.00001")
                    );
                    console.log('✅ createAuction gas estimation works:', gasEstimate.toString());
                } catch (gasError) {
                    console.log('❌ createAuction gas estimation failed:', gasError.message);
                    console.log('This confirms FHE operations are not supported on this network');
                }

            } catch (error) {
                console.error('❌ FHE test failed:', error);
                alert(`FHE test failed: ${error.message}`);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            init();
            setupFormValidation();

            // Event listeners for existing buttons only
            // Deployment buttons have been removed
        });
    </script>
</body>
</html>